<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Spring Boot 集成 Memcache | MAXSH NOTES</title>
    <meta name="description" content="Spring Boot 集成 Memcache">
    <link rel="apple-touch-icon" sizes="180x180" href="/images/icons/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/icons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/icons/favicon-16x16.png">
  <link rel="manifest" href="/manifest.json">
  <link rel="mask-icon" href="/images/icons/safari-pinned-tab.svg" color="#5bbad5">
  <meta name="msapplication-TileColor" content="#ffc40d">
  <meta name="msapplication-TileImage" content="/images/icons/mstile-144x144.png">
  <meta name="theme-color" content="#ffffff">
    
    <link rel="preload" href="/assets/css/0.styles.53bed4c3.css" as="style"><link rel="preload" href="/assets/js/app.fb9aeb92.js" as="script"><link rel="preload" href="/assets/js/2.3b98a9ec.js" as="script"><link rel="preload" href="/assets/js/33.7ba8a905.js" as="script"><link rel="preload" href="/assets/js/7.2146668d.js" as="script"><link rel="prefetch" href="/assets/js/10.e79002b5.js"><link rel="prefetch" href="/assets/js/11.a0ca7616.js"><link rel="prefetch" href="/assets/js/12.790a2fa6.js"><link rel="prefetch" href="/assets/js/13.8fc0caaa.js"><link rel="prefetch" href="/assets/js/14.39a19598.js"><link rel="prefetch" href="/assets/js/15.9e8e567e.js"><link rel="prefetch" href="/assets/js/16.5146b6f2.js"><link rel="prefetch" href="/assets/js/17.c933c97e.js"><link rel="prefetch" href="/assets/js/18.2638b416.js"><link rel="prefetch" href="/assets/js/19.d62f5327.js"><link rel="prefetch" href="/assets/js/20.b426461c.js"><link rel="prefetch" href="/assets/js/21.98c94019.js"><link rel="prefetch" href="/assets/js/22.ee261d60.js"><link rel="prefetch" href="/assets/js/23.ce2131a6.js"><link rel="prefetch" href="/assets/js/24.b184e7f4.js"><link rel="prefetch" href="/assets/js/25.2ad1ecee.js"><link rel="prefetch" href="/assets/js/26.465d4f9a.js"><link rel="prefetch" href="/assets/js/27.7b77fa56.js"><link rel="prefetch" href="/assets/js/28.6eba6aa8.js"><link rel="prefetch" href="/assets/js/29.a61ab99c.js"><link rel="prefetch" href="/assets/js/3.c7b8ed7f.js"><link rel="prefetch" href="/assets/js/30.236845a5.js"><link rel="prefetch" href="/assets/js/31.0fc36ead.js"><link rel="prefetch" href="/assets/js/32.84e16998.js"><link rel="prefetch" href="/assets/js/34.47787ef7.js"><link rel="prefetch" href="/assets/js/35.57c8f76a.js"><link rel="prefetch" href="/assets/js/36.10b5ba1b.js"><link rel="prefetch" href="/assets/js/37.d9863cfb.js"><link rel="prefetch" href="/assets/js/4.e0752412.js"><link rel="prefetch" href="/assets/js/5.843cb0b9.js"><link rel="prefetch" href="/assets/js/6.f0192e09.js"><link rel="prefetch" href="/assets/js/8.8ba8e383.js"><link rel="prefetch" href="/assets/js/9.387923a2.js">
    <link rel="stylesheet" href="/assets/css/0.styles.53bed4c3.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/images/logo.png" alt="MAXSH NOTES" class="logo"> <span class="site-name can-hide">MAXSH NOTES</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">主页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="练习项目" class="dropdown-title"><span class="title">练习项目</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/01_proj/springboot_mybatisplus.html" class="nav-link">SpringBoot集成MyBatisPlus</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="学习笔记" class="dropdown-title"><span class="title">学习笔记</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>后端笔记</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/04_java/" class="nav-link">java</a></li><li class="dropdown-subitem"><a href="/06_spring/" class="nav-link">spring</a></li><li class="dropdown-subitem"><a href="/07_springboot/" class="nav-link router-link-active">springboot</a></li></ul></li><li class="dropdown-item"><h4>Linux</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/05_linux/" class="nav-link">linux</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="工具" class="dropdown-title"><span class="title">工具</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/02_guide/" class="nav-link">markdown语法</a></li><li class="dropdown-item"><!----> <a href="http://docs.nigeerhuo.com/docker" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Docker绿皮书
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="/08_tool/01_tree.html" class="nav-link">用命令行生成目录结构树</a></li><li class="dropdown-item"><!----> <a href="http://freemarker.foofun.cn/dgui_template_overallstructure.html" target="_blank" rel="noopener noreferrer" class="nav-link external">
  freemarker在线手册
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div><div class="nav-item"><a href="/03_about/" class="nav-link">about</a></div><div class="nav-item"><a href="https://gitee.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Gitee
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <a href="https://github.com/maxsh-io/notes" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">主页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="练习项目" class="dropdown-title"><span class="title">练习项目</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/01_proj/springboot_mybatisplus.html" class="nav-link">SpringBoot集成MyBatisPlus</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="学习笔记" class="dropdown-title"><span class="title">学习笔记</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>后端笔记</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/04_java/" class="nav-link">java</a></li><li class="dropdown-subitem"><a href="/06_spring/" class="nav-link">spring</a></li><li class="dropdown-subitem"><a href="/07_springboot/" class="nav-link router-link-active">springboot</a></li></ul></li><li class="dropdown-item"><h4>Linux</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/05_linux/" class="nav-link">linux</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="工具" class="dropdown-title"><span class="title">工具</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/02_guide/" class="nav-link">markdown语法</a></li><li class="dropdown-item"><!----> <a href="http://docs.nigeerhuo.com/docker" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Docker绿皮书
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="/08_tool/01_tree.html" class="nav-link">用命令行生成目录结构树</a></li><li class="dropdown-item"><!----> <a href="http://freemarker.foofun.cn/dgui_template_overallstructure.html" target="_blank" rel="noopener noreferrer" class="nav-link external">
  freemarker在线手册
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div><div class="nav-item"><a href="/03_about/" class="nav-link">about</a></div><div class="nav-item"><a href="https://gitee.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Gitee
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <a href="https://github.com/maxsh-io/notes" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Spring Boot</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/07_springboot/" class="sidebar-link">介绍</a></li><li><a href="/07_springboot/01_HelloWorld.html" class="sidebar-link">SpringBoot Hello World</a></li><li><a href="/07_springboot/02_Test.html" class="sidebar-link">SpringBoot中单元测试</a></li><li><a href="/07_springboot/02_Web.html" class="sidebar-link">SpringBoot基本使用</a></li><li><a href="/07_springboot/03_Jsp.html" class="sidebar-link">SpringBoot中使用Jsp</a></li><li><a href="/07_springboot/04_Upload.html" class="sidebar-link">SpringBoot和Freemarker文件上传</a></li><li><a href="/07_springboot/05_FastDFS.html" class="sidebar-link">使用SpringBoot上传文件到FastDFS</a></li><li><a href="/07_springboot/06_RESTful.html" class="sidebar-link">SpringBoot构建RESTful Web服务</a></li><li><a href="/07_springboot/07_Swagger.html" class="sidebar-link">使用Swagger 2 构建API文档</a></li><li><a href="/07_springboot/08_WebSocket.html" class="sidebar-link">SpringBoot WebSocket创建聊天室</a></li><li><a href="/07_springboot/09_Jdbc.html" class="sidebar-link">SpringBoot使用JDBC操作数据库</a></li><li><a href="/07_springboot/10_MybatisXML.html" class="sidebar-link">SpringBoot集成Mybatis XML 配置版</a></li><li><a href="/07_springboot/11_MybatisAnnotation.html" class="sidebar-link">SpringBoot集成Mybatis 注解版</a></li><li><a href="/07_springboot/12_SpringDataJPA.html" class="sidebar-link">Spring Data JPA的使用</a></li><li><a href="/07_springboot/13_Druid.html" class="sidebar-link">Spring Boot 集成 Druid 监控数据源</a></li><li><a href="/07_springboot/14_Memcache.html" class="active sidebar-link">Spring Boot 集成 Memcache</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/07_springboot/14_Memcache.html#memcache-介绍" class="sidebar-link">Memcache 介绍</a></li><li class="sidebar-sub-header"><a href="/07_springboot/14_Memcache.html#memcache-特点" class="sidebar-link">Memcache 特点</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/07_springboot/14_Memcache.html#协议简单" class="sidebar-link">协议简单</a></li><li class="sidebar-sub-header"><a href="/07_springboot/14_Memcache.html#基于-libevent-的事件处理" class="sidebar-link">基于 Libevent 的事件处理</a></li><li class="sidebar-sub-header"><a href="/07_springboot/14_Memcache.html#内置内存存储方式" class="sidebar-link">内置内存存储方式</a></li><li class="sidebar-sub-header"><a href="/07_springboot/14_Memcache.html#不适应场景" class="sidebar-link">不适应场景</a></li></ul></li><li class="sidebar-sub-header"><a href="/07_springboot/14_Memcache.html#memcache-客户端" class="sidebar-link">Memcache 客户端</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/07_springboot/14_Memcache.html#spymemcached-介绍" class="sidebar-link">Spymemcached 介绍</a></li><li class="sidebar-sub-header"><a href="/07_springboot/14_Memcache.html#xmemcached-简介" class="sidebar-link">XMemcached 简介</a></li></ul></li><li class="sidebar-sub-header"><a href="/07_springboot/14_Memcache.html#工程实战" class="sidebar-link">工程实战</a></li><li class="sidebar-sub-header"><a href="/07_springboot/14_Memcache.html#xmemcached-语法介绍" class="sidebar-link">XMemcached 语法介绍</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/07_springboot/14_Memcache.html#常用操作" class="sidebar-link">常用操作</a></li><li class="sidebar-sub-header"><a href="/07_springboot/14_Memcache.html#incr-和-decr" class="sidebar-link">Incr 和 Decr</a></li><li class="sidebar-sub-header"><a href="/07_springboot/14_Memcache.html#counter" class="sidebar-link">Counter</a></li><li class="sidebar-sub-header"><a href="/07_springboot/14_Memcache.html#cas-操作" class="sidebar-link">CAS 操作</a></li><li class="sidebar-sub-header"><a href="/07_springboot/14_Memcache.html#设置超时时间" class="sidebar-link">设置超时时间</a></li><li class="sidebar-sub-header"><a href="/07_springboot/14_Memcache.html#更新缓存过期时间" class="sidebar-link">更新缓存过期时间</a></li></ul></li><li class="sidebar-sub-header"><a href="/07_springboot/14_Memcache.html#memcached-集群" class="sidebar-link">Memcached 集群</a></li><li class="sidebar-sub-header"><a href="/07_springboot/14_Memcache.html#sasl-验证" class="sidebar-link">SASL 验证</a></li><li class="sidebar-sub-header"><a href="/07_springboot/14_Memcache.html#查看统计信息" class="sidebar-link">查看统计信息</a></li></ul></li><li><a href="/07_springboot/15_Redis.html" class="sidebar-link">Spring Boot 集成 Redis</a></li><li><a href="/07_springboot/16_RedisSession.html" class="sidebar-link">Redis 实现Session共享</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="spring-boot-集成-memcache"><a href="#spring-boot-集成-memcache" class="header-anchor">#</a> Spring Boot 集成 Memcache</h1> <h2 id="memcache-介绍"><a href="#memcache-介绍" class="header-anchor">#</a> Memcache 介绍</h2> <p>Memcache 是一个自由和开放源代码、高性能、分配的内存对象缓存系统。简单来说，Memcache 是一个高性能的分布式内存对象的 key-value 缓存系统，用于加速动态 Web 应用程序，减轻数据库负载，现在也有很多人将它作为内存式数据库在使用。</p> <p>它可以应对任意多个连接，使用非阻塞的网络 IO，由于它的工作机制是在内存中开辟一块空间，然后建立一个 Hash 表，Memcached 自动管理这些 Hash 表。</p> <p>Memcache 由国外社区网站 LiveJournal 开发团队开发，设计理念就是小而强大，它简单的设计促进了快速部署、易于开发并解决面对大规模的数据缓存的许多难题，而所开放的 API 使得 Memcache 能用于 Java、C/C++/C#、Perl、Python、PHP、Ruby 等大部分流行的程序语言。</p> <div class="custom-block tip"><p class="custom-block-title">Memcache 和 Memcached 的区别</p> <p>Memcache 是这个项目的名称，而 Memcached 是服务器端的主程序名称。</p></div> <h2 id="memcache-特点"><a href="#memcache-特点" class="header-anchor">#</a> Memcache 特点</h2> <h3 id="协议简单"><a href="#协议简单" class="header-anchor">#</a> 协议简单</h3> <p>Memcache 的服务端客户端通信使用简单的文本协议，通过 Telnet 即可在 Memcached 上存取数据。</p> <h3 id="基于-libevent-的事件处理"><a href="#基于-libevent-的事件处理" class="header-anchor">#</a> 基于 Libevent 的事件处理</h3> <p>Libevent 是一套跨平台的事件处理接口的封装，能够兼容包括这些操作系统：Windows/Linux/BSD/Solaris 等操作系统的的事件处理，包装的接口包括：poll、select（Windows）、epoll（Linux）、kqueue（BSD）/dev/pool（Solaris）。</p> <p>Memcache 使用 Libevent 来进行网络并发连接的处理，能够保持在很大并发情况下，仍旧能够保持快速的响应能力。</p> <h3 id="内置内存存储方式"><a href="#内置内存存储方式" class="header-anchor">#</a> 内置内存存储方式</h3> <p>Memcache 中保存的数据都存储在 Memcache 内置的内存存储空间中。由于数据仅存在于内存中，因此重启 Memcache、重启操作系统会导致数据全部丢失。Memcache LRU（Least Recently Used）算法自动删除不使用的缓存，不过这个功能是可以配置的，Memcache 启动时通过“-M”参数可以禁止 LRU。不过，Memcache 本身是为缓存而设计的，建议开启 LRU。</p> <h3 id="不适应场景"><a href="#不适应场景" class="header-anchor">#</a> 不适应场景</h3> <ul><li>缓存对象不能大于 1 MB</li> <li>key 的长度大于 250 字符</li> <li>Memcache 未提供任何安全策略</li> <li>不支持持久化</li></ul> <h2 id="memcache-客户端"><a href="#memcache-客户端" class="header-anchor">#</a> Memcache 客户端</h2> <p>Memcached Client 目前有 3 种：</p> <ul><li>Memcached Client for Java（已经停止更新）</li> <li>SpyMemcached（已经停止更新）</li> <li>XMemcached（主流使用）</li></ul> <p>Memcached Client for Java 比 SpyMemcached 更稳定、更早、更广泛；SpyMemcached 比 Memcached Client for Java 更高效；XMemcached 比 SpyMemcache 并发效果更好。</p> <h3 id="spymemcached-介绍"><a href="#spymemcached-介绍" class="header-anchor">#</a> Spymemcached 介绍</h3> <p>Spymemcached 是一个采用 Java 开发的异步、单线程的 Memcached 客户端，使用 NIO 实现。Spymemcached 是 Memcached 的一个流行的 Java Client 库，性能表现出色，广泛应用于 Java + Memcached 项目中。</p> <p>Spymemcached 最早由 Dustin Sallings 开发，Dustin 后来和别人一起创办了 Couchbase（原NorthScale），职位为首席架构师，2014 年加入 Google。</p> <h3 id="xmemcached-简介"><a href="#xmemcached-简介" class="header-anchor">#</a> XMemcached 简介</h3> <p>现在使用最广泛的 Memcache Java 客户端是 XMemcached，它是一个新的 Java Memcache Client 。Memcached 通过它的自定义协议与客户端交互，而 XMemcached 就是它的一个 Java 客户端实现。XMemcached 支持设置连接池、宕机报警、使用二进制文件、一致性哈希算法、进行数据压缩等操作，总结如下：</p> <ul><li>高性能，由 Nio 支持；</li> <li>协议完整，Xmemcached 支持所有的 Memcached 协议，包括 1.4.0 正式开始使用的二进制协议；</li> <li>支持客户端分布，提供了一致性哈希（Consistent Hash）算法的实现；</li> <li>允许设置节点权重，XMemcached 允许通过设置节点的权重来调节 Memcached 的负载，设置的权重越高，该 Memcached 节点存储的数据将越多，所承受的负载越大；</li> <li>动态增删节点，Memcached 允许通过 JMX 或者代码编程实现节点的动态添加或者移除，方便用户扩展和替换节点等；</li> <li>XMemcached 通过 JMX 暴露的一些接口，支持 Client 本身的监控和调整，允许动态设置调优参数、查看统计数据、动态增删节点等；</li> <li>支持客户端连接池，对同一个 Memcached 可以创建 N 个连接组成连接池来提高客户端在高并发环境下的表现，而这一切对使用者来说却是透明的；</li> <li>可扩展性，XMemcached 是基于 Java Nio 框架 Yanf4j 实现的，因此在实现上结构相对清楚，分层比较明晰。</li></ul> <h2 id="工程实战"><a href="#工程实战" class="header-anchor">#</a> 工程实战</h2> <p>添加依赖包：</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.googlecode.xmemcached<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>xmemcached<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.4.5<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>添加配置文件</p> <div class="language-properties extra-class"><pre class="language-properties"><code><span class="token comment"># 单个 Memcached 配置</span>
<span class="token attr-name">memcached.servers</span><span class="token punctuation">=</span><span class="token attr-value">192.168.0.161:11211</span>
<span class="token comment"># 连接池</span>
<span class="token attr-name">memcached.poolSize</span><span class="token punctuation">=</span><span class="token attr-value">10</span>
<span class="token comment">#操作超时时间</span>
<span class="token attr-name">memcached.opTimeout</span><span class="token punctuation">=</span><span class="token attr-value">6000</span>
</code></pre></div><p>配置 Memcached 的地址和端口号、连接池和操作超时时间，使用集群时可以拼接多个地址：<strong>&quot;host1:port1 host2:port2 …&quot;</strong>。</p> <p>创建 XMemcachedProperties 类，读配置信息：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@ConfigurationProperties</span><span class="token punctuation">(</span>prefix <span class="token operator">=</span> <span class="token string">&quot;memcached&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">XMemcachedProperties</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> servers<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> poolSize<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">long</span> opTimeout<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>初始化Memcached 。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MemcachedConfig</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">XMemcachedProperties</span> xMemcachedProperties<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">MemcachedClient</span> <span class="token function">getMemcachedClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">MemcachedClient</span> memcachedClient <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">MemcachedClientBuilder</span> builder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMemcachedClientBuilder</span><span class="token punctuation">(</span><span class="token class-name">AddrUtil</span><span class="token punctuation">.</span><span class="token function">getAddresses</span><span class="token punctuation">(</span>xMemcachedProperties<span class="token punctuation">.</span><span class="token function">getServers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            builder<span class="token punctuation">.</span><span class="token function">setConnectionPoolSize</span><span class="token punctuation">(</span>xMemcachedProperties<span class="token punctuation">.</span><span class="token function">getPoolSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            builder<span class="token punctuation">.</span><span class="token function">setOpTimeout</span><span class="token punctuation">(</span>xMemcachedProperties<span class="token punctuation">.</span><span class="token function">getOpTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            memcachedClient <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;inint MemcachedClient failed &quot;</span><span class="token punctuation">,</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> memcachedClient<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>测试一下</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@SpringBootTest</span>
<span class="token keyword">class</span> <span class="token class-name">MemcacheApplicationTests</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">MemcachedClient</span> memcachedClient<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">void</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">{</span>
        memcachedClient<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">&quot;Hello,xmemcached&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> value <span class="token operator">=</span> memcachedClient<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;hello=&quot;</span> <span class="token operator">+</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        memcachedClient<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p>存储数据是通过 set 方法，它有三个参数，第一个是存储的 key 名称，第二个是 expire 时间（单位秒），超过这个时间，memcached 将这个数据替换出去，0 表示永久存储（默认是一个月），第三个参数就是实际存储的数据，可以是任意的 Java 可序列化类型。</p> <p>获取存储的数据是通过 get 方法，传入 key 名称即可；如果要删除存储的数据，可以通过 delete 方法，它也是接受 key 名称作为参数。</p> <p>执行 testMemcached() 单元测试之后，控制台会输出：</p> <div class="language- extra-class"><pre class="language-text"><code>hello=Hello,xmemcached
</code></pre></div><p>证明 Memcached 配置、设置和获取值成功。</p> <h2 id="xmemcached-语法介绍"><a href="#xmemcached-语法介绍" class="header-anchor">#</a> XMemcached 语法介绍</h2> <h3 id="常用操作"><a href="#常用操作" class="header-anchor">#</a> 常用操作</h3> <ul><li>add 命令，用于将 value（数据值）存储在指定的 key（键）中。如果 add 的 key 已经存在，则不会更新数据（过期的 key 会更新），之前的值将仍然保持相同，并且将获得响应 NOT_STORED。</li> <li>replace 命令，用于替换已存在的 key（键）的 value（数据值）。如果 key 不存在，则替换失败，并且将获得响应 NOT_STORED。</li> <li>append 命令，用于向已存在 key（键）的 value（数据值）后面追加数据。</li> <li>prepend 命令，用于向已存在 key（键）的 value（数据值）前面追加数据。</li> <li>deleteWithNoReply 方法，这个方法删除数据并且告诉 Memcached，不用返回应答，因此这个方法不会等待应答直接返回，比较适合于批量处理。</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testMore</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>memcachedClient<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">&quot;world&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;set error&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>memcachedClient<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">&quot;dennis&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Add error,key is existed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>memcachedClient<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">&quot;dennis&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;replace error&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    memcachedClient<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot; good&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    memcachedClient<span class="token punctuation">.</span><span class="token function">prepend</span><span class="token punctuation">(</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;hello &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> name <span class="token operator">=</span> memcachedClient<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">StringTranscoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    memcachedClient<span class="token punctuation">.</span><span class="token function">deleteWithNoReply</span><span class="token punctuation">(</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="incr-和-decr"><a href="#incr-和-decr" class="header-anchor">#</a> Incr 和 Decr</h3> <p>Incr 和 Decr 类似数据的增和减，两个操作类似 Java 中的原子类如 AtomicIntger，用于原子递增或者递减变量数值，Incr 和 Decr 都有三个参数的方法，第一个参数指定递增的 key 名称，第二个参数指定递增的幅度大小，第三个参数指定当 key 不存在的情况下的初始值，两个参数的重载方法省略了第三个参数，默认指定为 0。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testIncrDecr</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    memcachedClient<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token string">&quot;Incr&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    memcachedClient<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token string">&quot;Decr&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>memcachedClient<span class="token punctuation">.</span><span class="token function">incr</span><span class="token punctuation">(</span><span class="token string">&quot;Incr&quot;</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>memcachedClient<span class="token punctuation">.</span><span class="token function">incr</span><span class="token punctuation">(</span><span class="token string">&quot;Incr&quot;</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>memcachedClient<span class="token punctuation">.</span><span class="token function">incr</span><span class="token punctuation">(</span><span class="token string">&quot;Incr&quot;</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>memcachedClient<span class="token punctuation">.</span><span class="token function">decr</span><span class="token punctuation">(</span><span class="token string">&quot;Decr&quot;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>memcachedClient<span class="token punctuation">.</span><span class="token function">decr</span><span class="token punctuation">(</span><span class="token string">&quot;Decr&quot;</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="counter"><a href="#counter" class="header-anchor">#</a> Counter</h3> <p>Xmemcached 还提供了一个称为计数器的封装，它封装了 incr/decr 方法，使用它就可以类似 AtomicLong 那样去操作计数</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testCounter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token class-name">Counter</span> counter <span class="token operator">=</span> memcachedClient<span class="token punctuation">.</span><span class="token function">getCounter</span><span class="token punctuation">(</span><span class="token string">&quot;counter&quot;</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;counter=&quot;</span> <span class="token operator">+</span> counter<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> c1 <span class="token operator">=</span> counter<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;counter=&quot;</span> <span class="token operator">+</span> c1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> c2 <span class="token operator">=</span> counter<span class="token punctuation">.</span><span class="token function">decrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;counter=&quot;</span> <span class="token operator">+</span> c2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> c3 <span class="token operator">=</span> counter<span class="token punctuation">.</span><span class="token function">addAndGet</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;counter=&quot;</span> <span class="token operator">+</span> c3<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li><code>memcachedClient.getCounter(&quot;counter&quot;,10)</code>，第一个参数为计数器的 key，第二参数当 key 不存在时的默认值；</li> <li><code>counter.incrementAndGet()</code>，执行一次给计数器加 1；</li> <li><code>counter.decrementAndGet()</code>，执行一次给计数器减 1。</li></ul> <p>查看 counter.addAndGet(-10) 源码（如下），发现 addAndGet() 会根据传入的值的正负来判断，选择直接给对应的 key 加多少或者减多少，底层也是使用了 incr() 和 decr() 方法。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">addAndGet</span><span class="token punctuation">(</span><span class="token keyword">long</span> delta<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">MemcachedException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">,</span> <span class="token class-name">TimeoutException</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> delta <span class="token operator">&gt;=</span> <span class="token number">0L</span> <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span>memcachedClient<span class="token punctuation">.</span><span class="token function">incr</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>key<span class="token punctuation">,</span> delta<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>initialValue<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>memcachedClient<span class="token punctuation">.</span><span class="token function">decr</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>key<span class="token punctuation">,</span> <span class="token operator">-</span>delta<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>initialValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Counter 适合在高并发抢购场景下做并发控制。</p> <h3 id="cas-操作"><a href="#cas-操作" class="header-anchor">#</a> CAS 操作</h3> <p>Memcached 是通过 CAS 协议实现原子更新，所谓原子更新就是 Compare and Set，原理类似乐观锁，每次请求存储某个数据同时要附带一个 CAS 值，Memcached 比对这个 CAS 值与当前存储数据的 CAS 值是否相等，如果相等就让新的数据覆盖老的数据，如果不相等就认为更新失败，这在并发环境下特别有用。XMemcached 提供了对 CAS 协议的支持（无论是文本协议还是二进制协议），CAS 协议其实是分为两个步骤：获取 CAS 值和尝试更新，因此一个典型的使用场景如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">GetsResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">gets</span><span class="token punctuation">(</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">long</span> cas <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">getCas</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//尝试将 a 的值更新为 2</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>client<span class="token punctuation">.</span><span class="token function">cas</span><span class="token punctuation">(</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> cas<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;cas error&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>首先通过 gets 方法获取一个 GetsResponse，此对象包装了存储的数据和 CAS 值，然后通过 CAS 方法尝试原子更新，如果失败打印“cas error”。显然，这样的方式很繁琐，并且如果你想尝试多少次原子更新就需要一个循环来包装这一段代码，因此 XMemcached 提供了一个 <em>CASOperation</em> 接口包装了这部分操作，允许你尝试 N 次去原子更新某个 key 存储的数据，无需显式地调用 gets 获取 CAS 值，上面的代码简化为:</p> <div class="language-java extra-class"><pre class="language-java"><code>client<span class="token punctuation">.</span><span class="token function">cas</span><span class="token punctuation">(</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">CASOperation</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
             <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getMaxTries</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token class-name">Integer</span> <span class="token function">getNewValue</span><span class="token punctuation">(</span><span class="token keyword">long</span> currentCAS<span class="token punctuation">,</span> <span class="token class-name">Integer</span> currentValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token number">2</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>CASOpertion 接口只有两个方法，一个是设置最大尝试次数的 getMaxTries 方法，这里是尝试一次，如果尝试超过这个次数没有更新成功将抛出一个 TimeoutException，如果你想无限尝试（理论上），可以将返回值设定为 Integer.MAX_VALUE；另一个方法是根据当前获得的 GetsResponse 来决定更新数据的 getNewValue 方法，如果更新成功，这个方法返回的值将存储成功，其两个参数是最新一次 gets 返回的 GetsResponse 结果。</p> <h3 id="设置超时时间"><a href="#设置超时时间" class="header-anchor">#</a> 设置超时时间</h3> <p>XMemcached 由于是基于 nio，因此通讯过程本身是异步的，client 发送一个请求给 Memcached，你是无法确定 Memcached 什么时候返回这个应答，客户端此时只有等待，因此还有个等待超时的概念在这里。客户端在发送请求后，开始等待应答，如果超过一定时间就认为操作失败，这个等待时间默认是 5 秒，也可以在获取的时候配置超时时间。</p> <div class="language-java extra-class"><pre class="language-java"><code>value <span class="token operator">=</span> memcachedClient<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">,</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>就是等待 3 秒超时，如果 3 秒超时就跑出 TimeutException，用户需要自己处理这个异常。因为等待是通过调用 CountDownLatch.await(timeout) 方法，所以用户还需要处理中断异常 InterruptException，最后的 MemcachedException 表示 Xmemcached 内部发生的异常，如解码编码错误、网络断开等异常情况。</p> <h3 id="更新缓存过期时间"><a href="#更新缓存过期时间" class="header-anchor">#</a> 更新缓存过期时间</h3> <p>经常有这样的需求，就是希望更新缓存数据的超时时间（expire time），现在 Memcached 已经支持 touch 协议，只需要传递 key 就更新缓存的超时时间：</p> <div class="language-java extra-class"><pre class="language-java"><code>memcachedClient<span class="token punctuation">.</span><span class="token function">touch</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span><span class="token keyword">new</span><span class="token operator">-</span>expire<span class="token operator">-</span>time<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>有时候你希望获取缓存数据并更新超时时间，这时候可以用 getAndTouch 方法（仅二进制协议支持）</p> <div class="language- extra-class"><pre class="language-text"><code>memcachedClient.getAndTouch(key,new-expire-time);
</code></pre></div><p>如果在使用过程中报以下错误，说明安装的 Memcached 服务不支持 touch 命令，建议升级。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">Caused</span> by<span class="token operator">:</span> net<span class="token punctuation">.</span>rubyeye<span class="token punctuation">.</span>xmemcached<span class="token punctuation">.</span>exception<span class="token punctuation">.</span><span class="token class-name">UnknownCommandException</span><span class="token operator">:</span> <span class="token class-name">Response</span> error<span class="token punctuation">,</span>error message<span class="token operator">:</span><span class="token class-name">Unknow</span> command TOUCH<span class="token punctuation">,</span>key<span class="token operator">=</span><span class="token class-name">Touch</span>
    at net<span class="token punctuation">.</span>rubyeye<span class="token punctuation">.</span>xmemcached<span class="token punctuation">.</span>command<span class="token punctuation">.</span><span class="token class-name">Command</span><span class="token punctuation">.</span><span class="token function">decodeError</span><span class="token punctuation">(</span><span class="token class-name">Command</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">250</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="memcached-集群"><a href="#memcached-集群" class="header-anchor">#</a> Memcached 集群</h2> <p>Memcached 的分布是通过客户端实现的，客户端根据 key 的哈希值得到将要存储的 Memcached 节点，并将对应的 value 存储到相应的节点。</p> <p>XMemcached 同样支持客户端的分布策略，默认分布的策略是按照 key 的哈希值模以连接数得到的余数，对应的连接就是将要存储的节点。如果使用默认的分布策略，不需要做任何配置或者编程。</p> <p>XMemcached 同样支持<a href="http://en.wikipedia.org/wiki/Consistent_hashing" target="_blank" rel="noopener noreferrer">一致性哈希<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>（Consistent Hash)，通过编程设置：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">MemcachedClientBuilder</span> builder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMemcachedClientBuilder</span><span class="token punctuation">(</span><span class="token class-name">AddrUtil</span><span class="token punctuation">.</span><span class="token function">getAddresses</span><span class="token punctuation">(</span><span class="token string">&quot;server1:11211 server2:11211 server3:11211&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
builder<span class="token punctuation">.</span><span class="token function">setSessionLocator</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">KetamaMemcachedSessionLocator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">MemcachedClient</span> client<span class="token operator">=</span>builder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>XMemcached 还提供了额外的一种哈希算法——选举散列，在某些场景下可以替代一致性哈希：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">MemcachedClientBuilder</span> builder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMemcachedClientBuilder</span><span class="token punctuation">(</span>
                                    <span class="token class-name">AddrUtil</span><span class="token punctuation">.</span><span class="token function">getAddresses</span><span class="token punctuation">(</span><span class="token string">&quot;server1:11211 server2:11211 server3:11211&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
builder<span class="token punctuation">.</span><span class="token function">setSessionLocator</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ElectionMemcachedSessionLocator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">MemcachedClient</span> mc <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>在集群的状态下可以给每个服务设置不同的权重：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">MemcachedClientBuilder</span> builder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMemcachedClientBuilder</span><span class="token punctuation">(</span><span class="token class-name">AddrUtil</span><span class="token punctuation">.</span><span class="token function">getAddresses</span><span class="token punctuation">(</span><span class="token string">&quot;localhost:12000 localhost:12001&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">MemcachedClient</span> memcachedClient<span class="token operator">=</span>builder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="sasl-验证"><a href="#sasl-验证" class="header-anchor">#</a> SASL 验证</h2> <p>Memcached 1.4.3 开始支持 SASL 验证客户端，在服务器配置启用 SASL 之后，客户端需要通过授权验证才可以跟 Memcached 继续交互，否则将被拒绝请求，XMemcached 1.2.5 开始支持这个特性。假设 Memcached 设置了 SASL 验证，典型地使用 CRAM-MD 5 或者 PLAIN 的文本用户名和密码的验证机制，假设用户名为 cacheuser，密码为 123456，那么编程的方式如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">MemcachedClientBuilder</span> builder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMemcachedClientBuilder</span><span class="token punctuation">(</span>
                <span class="token class-name">AddrUtil</span><span class="token punctuation">.</span><span class="token function">getAddresses</span><span class="token punctuation">(</span><span class="token string">&quot;localhost:11211&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
builder<span class="token punctuation">.</span><span class="token function">addAuthInfo</span><span class="token punctuation">(</span><span class="token class-name">AddrUtil</span><span class="token punctuation">.</span><span class="token function">getOneAddress</span><span class="token punctuation">(</span><span class="token string">&quot;localhost:11211&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">AuthInfo</span>
                <span class="token punctuation">.</span><span class="token function">typical</span><span class="token punctuation">(</span><span class="token string">&quot;cacheuser&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;123456&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Must use binary protocol</span>
builder<span class="token punctuation">.</span><span class="token function">setCommandFactory</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BinaryCommandFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">MemcachedClient</span> client<span class="token operator">=</span>builder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>请注意，授权验证仅支持二进制协议。</p> <h2 id="查看统计信息"><a href="#查看统计信息" class="header-anchor">#</a> 查看统计信息</h2> <p>Memcached 提供了统计协议用于查看统计信息：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">InetSocketAddress</span><span class="token punctuation">,</span><span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> result<span class="token operator">=</span>client<span class="token punctuation">.</span><span class="token function">getStats</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>getStats 方法返回一个 map ，其中存储了所有已经连接并且有效的 Memcached 节点返回的统计信息，你也可以统计具体的项目，如统计 items 项目：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">InetSocketAddress</span><span class="token punctuation">,</span><span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> result<span class="token operator">=</span>client<span class="token punctuation">.</span><span class="token function">getStatsByItem</span><span class="token punctuation">(</span><span class="token string">&quot;items&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>只要向 getStatsByItem 传入需要统计的项目名称即可，我们可以利用这个功能，来做 Memcached 状态监控等。</p> <blockquote><p>😃 [源码](😃 <a href="https://github.com/maxsh-io/proj_springboot_case/tree/master/jpa-multi-datasource" target="_blank" rel="noopener noreferrer">源码<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>)</p></blockquote></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/maxsh-io/notes/edit/master/docs/07_springboot/14_Memcache.md" target="_blank" rel="noopener noreferrer">修改文档！</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2019-12-25 15:00:40</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/07_springboot/13_Druid.html" class="prev">Spring Boot 集成 Druid 监控数据源</a></span> <span class="next"><a href="/07_springboot/15_Redis.html">Spring Boot 集成 Redis</a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----><!----></div></div>
    <script src="/assets/js/app.fb9aeb92.js" defer></script><script src="/assets/js/2.3b98a9ec.js" defer></script><script src="/assets/js/33.7ba8a905.js" defer></script><script src="/assets/js/7.2146668d.js" defer></script>
  </body>
</html>
